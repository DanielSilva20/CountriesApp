//
//  ChangeCurrencyViewController.swift
//  CountriesApp
//
//  Created by Daniel Silva on 05/04/2023.
//  Copyright (c) 2023 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol ChangeCurrencyDisplayLogic: AnyObject {
    func displaySomething(viewModel: ChangeCurrency.Country.ViewModel)
}

class ChangeCurrencyViewController: UIViewController, ChangeCurrencyDisplayLogic, UIPickerViewDelegate, UIPickerViewDataSource {
    var interactor: ChangeCurrencyBusinessLogic?
    var router: (NSObjectProtocol & ChangeCurrencyRoutingLogic & ChangeCurrencyDataPassing)?
    private var fromPickerView: UIPickerView!
    private var toPickerView: UIPickerView!
    private var pickerCountries: [String] = []
    private var countriesStackView: UIStackView!
    private var amountsStackView: UIStackView!
    
    private var fromCurrency: UITextField!
    private var toCurrency: UILabel!

    private var convertCurrencyButton: UIButton!

    private var currencyViewTitle: UILabel!
    private var countriesTitle: UILabel!
    private var amountsTitle: UILabel!
    
    // MARK: Object lifecycle
    
    override init(nibName nibNameOrNil: String?, bundle nibBundleOrNil: Bundle?) {
        super.init(nibName: nibNameOrNil, bundle: nibBundleOrNil)
        setup()
    }
    
    required init?(coder aDecoder: NSCoder) {
        super.init(coder: aDecoder)
        setup()
    }
    
    func createViews() {
        setUpViews()
        addViewsToSuperview()
        setUpConstraints()
        fromPickerView.delegate = self
        fromPickerView.dataSource = self
        toPickerView.delegate = self
        toPickerView.dataSource = self
    }
    
    private func setUpViews() {
        currencyViewTitle = UILabel()
        currencyViewTitle.text = "currency.title".localized
        currencyViewTitle.font = UIFont.boldSystemFont(ofSize: 24)
        currencyViewTitle.textAlignment = .center

        countriesStackView = UIStackView()
        countriesStackView.axis = .horizontal
        countriesStackView.alignment = .fill
        countriesStackView.distribution = .fillEqually
        countriesStackView.spacing = 15
        
        amountsStackView = UIStackView()
        amountsStackView.axis = .horizontal
        amountsStackView.distribution = .fill
        countriesStackView.distribution = .fillEqually
        amountsStackView.spacing = 15

        countriesTitle = UILabel()
        countriesTitle.text = "currency.countries.title".localized
        countriesTitle.font = UIFont.boldSystemFont(ofSize: 20)
        countriesTitle.textAlignment = .center

        fromPickerView = UIPickerView()
        toPickerView = UIPickerView()

        fromCurrency = UITextField()
        fromCurrency.borderStyle = .roundedRect
        fromCurrency.placeholder = "currency.from.search.text".localized
        fromCurrency.textAlignment = .center
        fromCurrency.layer.cornerRadius = 5
        fromCurrency.layer.borderWidth = 0.5
        fromCurrency.layer.borderColor = UIColor.lightGray.cgColor

        toCurrency = UILabel()
        toCurrency.backgroundColor = .white
        toCurrency.layer.cornerRadius = 5
        toCurrency.layer.borderWidth = 0.5
        toCurrency.layer.borderColor = UIColor.lightGray.cgColor
        toCurrency.text = ""
        toCurrency.textAlignment = .center

        amountsTitle = UILabel()
        amountsTitle.text = "currency.amounts.title".localized
        amountsTitle.font = UIFont.boldSystemFont(ofSize: 20)
        amountsTitle.textAlignment = .center

        convertCurrencyButton = UIButton()
        convertCurrencyButton.setTitle("currency.button.text".localized, for: .normal)
        convertCurrencyButton.setTitleColor(.white, for: .normal)
        convertCurrencyButton.contentEdgeInsets = UIEdgeInsets(top: 7, left: 10, bottom: 7, right: 10)
        convertCurrencyButton.layer.cornerRadius = 5
        convertCurrencyButton.backgroundColor = .systemBlue
        convertCurrencyButton.addTarget(self, action: #selector(convertCurrency), for: .touchUpInside)
        convertCurrencyButton.translatesAutoresizingMaskIntoConstraints = false
    }
    
    private func addViewsToSuperview() {
        view.addSubview(currencyViewTitle)
//        view.addSubview(countriesTitle)
        countriesStackView.addArrangedSubview(fromPickerView)
        countriesStackView.addArrangedSubview(toPickerView)
        view.addSubview(countriesStackView)
        view.addSubview(amountsTitle)
        amountsStackView.addArrangedSubview(fromCurrency)
        amountsStackView.addArrangedSubview(toCurrency)
        view.addSubview(amountsStackView)
        view.addSubview(convertCurrencyButton)
    }
    
    private func setUpConstraints() {
        fromPickerView.translatesAutoresizingMaskIntoConstraints = false
        countriesStackView.translatesAutoresizingMaskIntoConstraints = false
        toPickerView.translatesAutoresizingMaskIntoConstraints = false
        amountsStackView.translatesAutoresizingMaskIntoConstraints = false
        fromCurrency.translatesAutoresizingMaskIntoConstraints = false
        toCurrency.translatesAutoresizingMaskIntoConstraints = false
        convertCurrencyButton.translatesAutoresizingMaskIntoConstraints = false
        currencyViewTitle.translatesAutoresizingMaskIntoConstraints = false
        countriesTitle.translatesAutoresizingMaskIntoConstraints = false
        amountsTitle.translatesAutoresizingMaskIntoConstraints = false
        
        NSLayoutConstraint.activate([
            currencyViewTitle.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor, constant: 20),
            currencyViewTitle.centerXAnchor.constraint(equalTo: view.centerXAnchor),

            countriesStackView.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: 20),
            countriesStackView.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -20),
            countriesStackView.centerYAnchor.constraint(equalTo: view.centerYAnchor, constant: -50),
            countriesStackView.heightAnchor.constraint(equalToConstant: 150),

            amountsTitle.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: 20),
            amountsTitle.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -20),
            amountsTitle.topAnchor.constraint(equalTo: countriesStackView.bottomAnchor, constant: 20),

            amountsStackView.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: 20),
            amountsStackView.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -20),
            amountsStackView.topAnchor.constraint(equalTo: amountsTitle.bottomAnchor, constant: 20),
            fromCurrency.widthAnchor.constraint(equalTo: toCurrency.widthAnchor),

            convertCurrencyButton.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            convertCurrencyButton.topAnchor.constraint(equalTo: amountsStackView.bottomAnchor, constant: 40),
        ])
    }
    
    
    // MARK: Setup
    
    private func setup() {
        let viewController = self
        let interactor = ChangeCurrencyInteractor()
        let presenter = ChangeCurrencyPresenter()
        let router = ChangeCurrencyRouter()
        viewController.interactor = interactor
        viewController.router = router
        interactor.presenter = presenter
        presenter.viewController = viewController
        router.viewController = viewController
        router.dataStore = interactor
    }
    
    // MARK: View lifecycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white
    }
    
    override func viewWillAppear(_ animated: Bool) {
        createViews()
        showCountriesPicker()
    }
    
    func showCountriesPicker() {
        guard let countries = router?.dataStore?.countries else { return }
        let request = ChangeCurrency.Country.Request(countries: countries)
        interactor?.doSomething(request: request)
    }
    
    func displaySomething(viewModel: ChangeCurrency.Country.ViewModel) {
        pickerCountries = viewModel.countryName
        print("pickerCountries -> \(pickerCountries)")
        fromPickerView.reloadAllComponents()
        toPickerView.reloadAllComponents()
    }

    @objc private func convertCurrency() {
        let fromCurrencyCountry = pickerCountries[fromPickerView.selectedRow(inComponent: 0)]
        let toCurrencyCountry = pickerCountries[toPickerView.selectedRow(inComponent: 0)]
        let fromSearchText = fromCurrency.text ?? ""

        print("From currency: \(fromCurrencyCountry)")
        print("To currency: \(toCurrencyCountry)")
        print("From search text: \(fromSearchText)")
    }
    
    func numberOfComponents(in pickerView: UIPickerView) -> Int {
        return 1
    }
    
    func pickerView(_ pickerView: UIPickerView, numberOfRowsInComponent component: Int) -> Int {
        return pickerCountries.count
    }
    
    func pickerView(_ pickerView: UIPickerView, titleForRow row: Int, forComponent component: Int) -> String? {
        return pickerCountries[row]
    }
    
}
